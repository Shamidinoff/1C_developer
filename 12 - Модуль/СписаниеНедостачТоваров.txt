КОД ИЗ УРОКА

Функция СведенияОВнешнейОбработке() Экспорт
ПараметрыРегистрации = Новый Структура;
МассивНазначений = Новый Массив;
МассивНазначений.Добавить("Документ.СписаниеНедостачТоваров"); //Указываем документ к которому делаем внешнюю печ. форму
ПараметрыРегистрации.Вставить("Вид", "ПечатнаяФорма"); //может быть - ПечатнаяФорма, ЗаполнениеОбъекта, ДополнительныйОтчет, СозданиеСвязанныхОбъектов...
ПараметрыРегистрации.Вставить("Назначение", МассивНазначений);
ПараметрыРегистрации.Вставить("Наименование", "Списание недостач"); //имя под которым обработка будет зарегестрирована в справочнике внешних обработок
ПараметрыРегистрации.Вставить("БезопасныйРежим", Истина);
ПараметрыРегистрации.Вставить("Версия", "2.2.2.0");
ПараметрыРегистрации.Вставить("Информация", "Эту ВПФ мы сделали для того что бы посмотреть возможности БСП ");
ТаблицаКоманд = ПолучитьТаблицуКоманд();
ДобавитьКоманду(ТаблицаКоманд, "Списание недостач", "Списание недостач", "ВызовСерверногоМетода", ложь, "ПечатьMXL");
ПараметрыРегистрации.Вставить("Команды", ТаблицаКоманд);

Возврат ПараметрыРегистрации;
КонецФункции    

Функция ПолучитьТаблицуКоманд() Экспорт
Команды = Новый ТаблицаЗначений;
Команды.Колонки.Добавить("Представление", Новый ОписаниеТипов("Строка"));//как будет выглядеть описание печ.формы для пользователя
Команды.Колонки.Добавить("Идентификатор", Новый ОписаниеТипов("Строка")); //имя макета печ.формы
Команды.Колонки.Добавить("Использование", Новый ОписаниеТипов("Строка")); //ВызовСерверногоМетода
Команды.Колонки.Добавить("ПоказыватьОповещение", Новый ОписаниеТипов("Булево"));
Команды.Колонки.Добавить("Модификатор", Новый ОписаниеТипов("Строка"));
Возврат Команды;
КонецФункции     

Процедура ДобавитьКоманду(ТаблицаКоманд, Представление, Идентификатор, Использование, ПоказыватьОповещение = Ложь, Модификатор = "") экспорт

НоваяКоманда = ТаблицаКоманд.Добавить();
НоваяКоманда.Представление = Представление;
НоваяКоманда.Идентификатор = Идентификатор;
НоваяКоманда.Использование = Использование;
НоваяКоманда.ПоказыватьОповещение = ПоказыватьОповещение;
НоваяКоманда.Модификатор = Модификатор;

КонецПроцедуры   

Процедура Печать(МассивОбъектов, КоллекцияПечатныхФорм,ОбъектыПечати, ПараметрыВывода) Экспорт

УправлениеПечатью.ВывестиТабличныйДокументВКоллекцию(КоллекцияПечатныхФорм, "Списание недостач", "Списание недостач",СформироватьПечатнуюФорму(МассивОбъектов[0], ОбъектыПечати));
КонецПроцедуры

Функция СформироватьПечатнуюФорму(ССылкаНаОбъект,ОбъектыПечати)Экспорт 
	
	ТабДок = Новый ТабличныйДокумент;
	
	//{{КОНСТРУКТОР_ЗАПРОСА_С_ОБРАБОТКОЙ_РЕЗУЛЬТАТА
	// Данный фрагмент построен конструктором.
	// При повторном использовании конструктора, внесенные вручную изменения будут утеряны!!!
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	СписаниеНедостачТоваров.Номер КАК Номер,
		|	СписаниеНедостачТоваров.Дата КАК Дата,
		|	СписаниеНедостачТоваров.Руководитель КАК Руководитель,
		|	СписаниеНедостачТоваров.Товары.(
		|		Ссылка КАК Ссылка,
		|		НомерСтроки КАК НомерСтроки,
		|		Номенклатура КАК Номенклатура,
		|		Характеристика КАК Характеристика,
		|		Назначение КАК Назначение,
		|		Количество КАК Количество,
		|		Серия КАК Серия,
		|		АналитикаУчетаНоменклатуры КАК АналитикаУчетаНоменклатуры,
		|		СтатусУказанияСерий КАК СтатусУказанияСерий
		|	) КАК Товары
		|ИЗ
		|	Документ.СписаниеНедостачТоваров КАК СписаниеНедостачТоваров
		|ГДЕ
		|	СписаниеНедостачТоваров.Ссылка = &СсылкаНаДокумент";
	
	Запрос.УстановитьПараметр("СсылкаНаДокумент", ССылкаНаОбъект);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Выборка = РезультатЗапроса.Выбрать();
	
	Пока Выборка.Следующий() Цикл
		// Вставить обработку выборки ВыборкаДетальныеЗаписи
	КонецЦикла;
	
	//}}КОНСТРУКТОР_ЗАПРОСА_С_ОБРАБОТКОЙ_РЕЗУЛЬТАТА

	
	Макет = ПолучитьМакет("Макет"); 
	
	ОбластьЗаголовок = Макет.ПолучитьОбласть("Заголовок");
	ОбластьШапка = Макет.ПолучитьОбласть("Шапка");
	ОбластьТоварыШапка = Макет.ПолучитьОбласть("ТоварыШапка");
	ОбластьТовары = Макет.ПолучитьОбласть("Товары");
	ОбластьПодвал = Макет.ПолучитьОбласть("Подвал");
	
	ОбластьЗаголовок.Параметры.Номер = Выборка.Номер;
	ОбластьЗаголовок.Параметры.Дата = Формат(Выборка.Дата,"ДЛФ=D");
	ТабДок.Вывести(ОбластьЗаголовок);
	ОбластьШапка.Параметры.Склад = Выборка.Склад;
	ТабДок.Вывести(ОбластьШапка);    
	ТабДок.Вывести(ОбластьТоварыШапка);
	
	ВыборкаТовары = Выборка.Товары.Выбрать();
	
	Пока ВыборкаТовары.Следующий() Цикл
		ОбластьТовары.Параметры.Номер = ВыборкаТовары.НомерСтроки;
		ОбластьТовары.Параметры.Товар = ВыборкаТовары.Номенклатура;
		ОбластьТовары.Параметры.Количество = ВыборкаТовары.Количество;
		ТабДок.Вывести(ОбластьТовары);
		
		ОбластьПодвал.Параметры.ОтветственныйСотрудник = Выборка.Руководитель;
		ТабДок.Вывести(ОбластьПодвал);
		
		ВставлятьРазделительСтраниц = Истина;
		ТабДок.АвтоМасштаб = Истина;
		Возврат ТабДок;
		
	КонецЦикла;
	



КонецФункции




















